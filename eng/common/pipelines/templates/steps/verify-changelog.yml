parameters:
  PackageName: 'not-specified'
  ServiceName: 'not-specified'

steps:
  - pwsh: |
      Import-Module "$(Build.SourcesDirectory)/eng/common/scripts/modules/common-manifest.psd1"
      $Language = "$(Build.Repository.Name)".Substring("$(Build.Repository.Name)".LastIndexOf('-') + 1)
      $PackageProp = Get-PkgProperties -PackageName ${{ parameters.PackageName }} -ServiceName ${{ parameters.ServiceName }} -Language $Language -RepoRoot $(Build.SourcesDirectory)
      Write-Host ($PackageProp | Format-List | Out-String)

      $ReleaseNotes = (& "$(Build.SourcesDirectory)/eng/common/Extract-ReleaseNotes.ps1" -ChangeLogLocation $PackageProp.pkgChangeLogPath -VersionString $PackageProp.pkgVersion -IncludeTitle $true) -Split [Environment]::NewLine

      # Verify Header Has Unreleased or an has accurate date
      $ReleaseTitle = $ReleaseNotes[0] -Split ' '

      if ($ReleaseTitle.Length -ne 3)
      {
        Write-Host ("##[warning]Changelog '{0}' has wrong release note title" -f $PackageProp.pkgChangeLogPath)
        Write-Host "##[info]Ensure the release date is included i.e. (yyyy-MM-dd) or (Unreleased) if not yet released"
        exit 1
      }

      if (('$(Build.Reason)' -eq 'Manual') -and ('$(SkipChangelogVerification)' -ne 'true'))
      {
        $CurrentDate = Get-Date -Format "yyyy-MM-dd"
        if ($ReleaseTitle[2] -ne $CurrentDate)
        {
          Write-Host ("##[warning]Incorrect Date: Please use the current date in the Changelog '{0}' before releasing the package" -f $PackageProp.pkgChangeLogPath)
          Write-Host "##[info]Testing Info"
          Write-Host "##[error]Testing Error"
          exit 1
        }
        if ($ReleaseNotes.Length -le 1)
        {
          Write-Host ("##[warning]Empty Release Notes for '{0}' in '{1}'" -f $PackageProp.pkgVersion, $PackageProp.pkgChangeLogPath)
          Write-Host "##[warning]Please ensure there is a release notes entry before releasing the package."
          exit 1
        }
      }

      Write-Host ($ReleaseNotes | Format-Table | Out-String)

    displayName: Verify ChangeLog